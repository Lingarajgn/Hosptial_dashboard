<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Case Details | SwiftAid</title>

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  background: #f5f8ff;
  font-family: "Poppins", sans-serif;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

.case-detail-container {
  width: 90%;
  max-width: 1100px;
  background: #fff;
  padding: 35px 40px;
  margin-top: 50px;
  border-radius: 15px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  display: flex;
  gap: 30px;
}

.case-left {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.case-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.case-detail-container h2 {
  color: #007bff;
  font-size: 26px;
  font-weight: 600;
  border-bottom: 2px solid #007bff;
  padding-bottom: 8px;
  margin-bottom: 25px;
}

.case-info p {
  margin: 10px 0;
  font-size: 16px;
  color: #333;
  line-height: 1.5;
}

.back-link {
  color: #007bff;
  text-decoration: none;
  margin-bottom: 20px;
  display: inline-block;
}

.back-link:hover {
  text-decoration: underline;
}

#caseMap {
  width: 100%;
  height: 420px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.status-badge {
  display: inline-block;
  padding: 8px 14px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 14px;
  margin-left: 5px;
}

.status-accepted { background: #d4edda; color: #155724; }
.status-rejected { background: #f8d7da; color: #721c24; }
.status-available { background: #d1ecf1; color: #0c5460; }

.link-note {
  font-size: 13px;
  color: #666;
  margin-top: 6px;
}

@media (max-width: 900px) {
  .case-detail-container {
    flex-direction: column;
    padding: 25px;
  }
  .case-right {
    margin-top: 20px;
  }
}
</style>
</head>

<body>
  <div style="display:flex;justify-content:center;width:100%;">
    <div class="case-detail-container">

      <!-- LEFT SIDE: Case Details -->
      <div class="case-left">
        <a href="{{ url_for('dashboard') }}" class="back-link">‚¨Ö Back to Dashboard</a>
        <h2>Case Details</h2>

        <div class="case-info">
          <p><strong>User Email:</strong> {{ incident.user_email }}</p>
          <p><strong>Latitude:</strong> {{ incident.lat }}</p>
          <p><strong>Longitude:</strong> {{ incident.lng }}</p>
          <p><strong>Acceleration Magnitude:</strong> {{ "%.2f"|format(incident.accel_mag) }}</p>
          <p><strong>Speed:</strong> {{ incident.speed }}</p>
          <p><strong>Reported At:</strong> {{ incident.created_at }}</p>
          <p><strong>Status:</strong>
            {% if incident.status == 'accepted' %}
              <span class="status-badge status-accepted">Accepted by {{ incident.accepted_by }}</span>
            {% elif incident.status == 'rejected' %}
              <span class="status-badge status-rejected">Rejected</span>
            {% else %}
              <span class="status-badge status-available">Available</span>
            {% endif %}
          </p>
        </div>

        <!-- Directions link -->
        <div id="directionsLink" style="margin-top:20px;text-align:center;"></div>
      </div>

      <!-- RIGHT SIDE: Map -->
      <div class="case-right">
        <div id="caseMap"></div>
      </div>
    </div>
  </div>

<script>
const incidentLat = Number({{ incident.lat }});
const incidentLng = Number({{ incident.lng }});

// Initialize Leaflet map
const map = L.map('caseMap').setView([incidentLat, incidentLng], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// Add marker for the incident
L.marker([incidentLat, incidentLng]).addTo(map)
  .bindPopup(`<b>{{ incident.user_email }}</b><br>üìç Accident Location: ${incidentLat.toFixed(4)}, ${incidentLng.toFixed(4)}`)
  .openPopup();

// Google Maps directions link ‚Äî uses user's real GPS automatically
const linkContainer = document.getElementById('directionsLink');
const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${incidentLat},${incidentLng}&travelmode=driving`;

linkContainer.innerHTML = `
  <a href="${mapsUrl}" target="_blank" style="
      background-color:#007bff;
      color:white;
      padding:10px 16px;
      border-radius:8px;
      text-decoration:none;
      font-weight:600;">
    üöó Open Directions in Google Maps
  </a>
  <p class="link-note">(Google Maps will automatically detect your current location.)</p>
`;
</script>
</body>
</html>
