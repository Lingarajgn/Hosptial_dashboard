<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Case Details | SwiftAid</title>

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  background:#f5f8ff;font-family:"Poppins",sans-serif;margin:0;
  display:flex;justify-content:center;align-items:flex-start;min-height:100vh;
}
.case-detail-container{
  width:90%;max-width:850px;background:#fff;padding:35px 40px;margin-top:50px;
  border-radius:15px;box-shadow:0 6px 16px rgba(0,0,0,0.1);
}
.case-detail-container h2{
  color:#007bff;font-size:26px;font-weight:600;border-bottom:2px solid #007bff;
  padding-bottom:8px;margin-bottom:25px;
}
.case-info p{margin:10px 0;font-size:16px;color:#333;line-height:1.5;}
.back-link{color:#007bff;text-decoration:none;margin-bottom:20px;display:inline-block;}
.back-link:hover{text-decoration:underline;}
#caseMap{width:100%;height:420px;margin-top:25px;border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.status-badge{display:inline-block;padding:8px 14px;border-radius:20px;
  font-weight:600;font-size:14px;margin-left:5px;}
.status-accepted{background:#d4edda;color:#155724;}
.status-rejected{background:#f8d7da;color:#721c24;}
.status-available{background:#d1ecf1;color:#0c5460;}
@media(max-width:768px){.case-detail-container{width:95%;padding:25px;}}
</style>
</head>

<body>
<div style="display:flex;justify-content:center;width:100%;">
<div class="case-detail-container">
  <a href="{{ url_for('dashboard') }}" class="back-link">‚¨Ö Back to Dashboard</a>
  <h2>Case Details</h2>

  <div class="case-info">
    <p><strong>User Email:</strong> {{ incident.user_email }}</p>
    <p><strong>Latitude:</strong> {{ incident.lat }}</p>
    <p><strong>Longitude:</strong> {{ incident.lng }}</p>
    <p><strong>Acceleration Magnitude:</strong> {{ "%.2f"|format(incident.accel_mag) }}</p>
    <p><strong>Speed:</strong> {{ incident.speed }}</p>
    <p><strong>Reported At:</strong> {{ incident.created_at }}</p>
    <p><strong>Status:</strong>
      {% if incident.status == 'accepted' %}
        <span class="status-badge status-accepted">Accepted by {{ incident.accepted_by }}</span>
      {% elif incident.status == 'rejected' %}
        <span class="status-badge status-rejected">Rejected</span>
      {% else %}
        <span class="status-badge status-available">Available</span>
      {% endif %}
    </p>
    <p><strong>Distance from You:</strong> <span id="distanceInfo">Fetching...</span></p>
  </div>

  <div id="caseMap"></div>
</div>
</div>

<script>
const lat={{ incident.lat }};
const lng={{ incident.lng }};
const API_KEY="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjExOGNhZGQxMzE0YTQ5MGE5NjkwYWIxYWY4MzVjMzBiIiwiaCI6Im11cm11cjY0In0=";   // ‚¨Ö replace this

const map=L.map('caseMap').setView([lat,lng],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,attribution:'¬© OpenStreetMap contributors'
}).addTo(map);

const caseMarker=L.marker([lat,lng]).addTo(map)
  .bindPopup(`<b>{{ incident.user_email }}</b><br>üìç Location: ${lat}, ${lng}`)
  .openPopup();

function haversine(lat1,lon1,lat2,lon2){
  const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
          Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async pos=>{
    const hLat=pos.coords.latitude, hLng=pos.coords.longitude;
    L.marker([hLat,hLng],{
      icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[30,30]})
    }).addTo(map).bindPopup("<b>üè• Your Location</b>").openPopup();

    const dist=haversine(hLat,hLng,lat,lng).toFixed(2);
    document.getElementById("distanceInfo").textContent=`${dist} km`;

    // --- Request real road route from ORS ---
    try{
      const url=`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY}&start=${hLng},${hLat}&end=${lng},${lat}`;
      const res=await fetch(url);
      const data=await res.json();
      const coords=data.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);
      L.polyline(coords,{color:"blue",weight:5}).addTo(map);

      const group=new L.featureGroup([caseMarker,L.marker([hLat,hLng])]);
      map.fitBounds(group.getBounds(),{padding:[50,50]});
    }catch(err){
      console.error("Route error:",err);
      alert("Could not load route data.");
    }
  },()=>{document.getElementById("distanceInfo").textContent="Unable to get your location.";});
}else{
  document.getElementById("distanceInfo").textContent="Geolocation not supported.";
}
</script>
</body>
</html>
