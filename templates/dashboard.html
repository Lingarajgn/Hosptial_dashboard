<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Dashboard | SwiftAid</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const incidentsData = {{ incidents|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}" defer></script>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="SwiftAid Logo" width="35">
            SwiftAid
        </div>

        <nav>
            <a href="#dashboard" class="active">ğŸ  Dashboard</a>
            <a href="#cases">ğŸš‘ Cases</a>
            <a href="#settings">âš™ï¸ Settings</a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <h2>Incident Dashboard</h2>

            <div class="profile-box">
                <span id="hospitalName">{{ hospital_name }}</span>
                <div class="dropdown" id="profileDropdown">
                    <button class="dropbtn">â–¼</button>
                    <div class="dropdown-content" id="dropdownMenu">
                        <a href="#">Profile</a>
                        <a href="{{ url_for('logout') }}">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="tab-section">
            <section id="stats">
                <div class="stat-box">
                    <span>{{ active_cases }}</span>
                    <p>Active Cases</p>
                </div>
                <div class="stat-box">
                    <span id="acceptedCases">{{ accepted_cases }}</span>
                    <p>Accepted Cases</p>
                </div>
            </section>

            <div class="map-container">
                <div id="map" class="map-placeholder"></div>
            </div>
        </section>

        <!-- Cases Section -->
        <section id="cases" class="cases-section tab-section" style="display: none;">
            <h2>ğŸš‘ Reported Cases</h2>

            {% if incidents %}
                {% for inc in incidents %}
                <div class="card" id="case-{{ inc._id }}">
                    <div class="card-header">
                        <h3>ğŸ“ {{ inc.user_email }}</h3>
                    </div>
                    <div class="card-body">
                        <p><strong>Latitude:</strong> {{ inc.lat }}</p>
                        <p><strong>Longitude:</strong> {{ inc.lng }}</p>
                        <p><strong>Acceleration Magnitude:</strong> {{ "%.2f"|format(inc.accel_mag) }}</p>
                        <p><strong>Speed:</strong> {{ inc.speed }}</p>
                        <p><strong>Reported At:</strong> {{ inc.created_at }}</p>

                        {% if inc.status_info %}
                            {% if inc.status_info.status == 'accepted' %}
                                {% if inc.status_info.hospital_name == hospital_name %}
                                    <p class="case-status accepted">âœ… Accepted by You</p>
                                {% else %}
                                    <p class="case-status taken">ğŸš« Already accepted by another hospital</p>
                                {% endif %}
                            {% elif inc.status_info.status == 'rejected' %}
                                <p class="case-status rejected">âŒ Rejected by a hospital</p>
                            {% endif %}
                        {% else %}
                            <div class="case-actions">
                                <button class="btn accept-btn" onclick="updateCaseStatus('{{ inc._id }}', 'accepted')">âœ… Accept Case</button>
                                <button class="btn reject-btn" onclick="updateCaseStatus('{{ inc._id }}', 'rejected')">âŒ Reject Case</button>
                            </div>
                            <p class="case-status" id="status-{{ inc._id }}"></p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-cases">No incident cases reported yet.</div>
            {% endif %}
        </section>

        <!-- Settings Section -->
        <section id="settings" class="settings-section tab-section" style="display: none;">
            <h2>âš™ï¸ Settings</h2>

            <div id="profileView" class="settings-form profile-view">
                <p><strong>Hospital Name:</strong> {{ user.hospital_name }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <p><strong>Phone:</strong> {{ user.get('phone', 'Not provided') }}</p>
                <p><strong>Location:</strong> {{ user.get('location', 'Not provided') }}</p>

                <div class="settings-buttons">
                    <button id="editProfileBtn" class="btn edit-btn">âœï¸ Edit Profile</button>
                </div>
            </div>

            <form id="editProfileForm" class="settings-form edit-profile-form" style="display: none;">
                <label for="hospital_name">Hospital Name</label>
                <input type="text" id="hospital_name" name="hospital_name" value="{{ user.hospital_name }}" required>

                <label for="phone">Phone</label>
                <input type="text" id="phone" name="phone" value="{{ user.get('phone', '') }}">

                <label for="location">Location</label>
                <input type="text" id="location" name="location" value="{{ user.get('location', '') }}">

                <div class="settings-buttons">
                    <button type="submit" class="btn save-btn">ğŸ’¾ Save Changes</button>
                    <button type="button" class="btn cancel-btn" id="cancelEditBtn">Cancel</button>
                </div>
            </form>

            <p id="updateMessage" class="update-message" style="display:none;"></p>
        </section>
    </main>
</body>
</html>
